# Generated by ts-toolkit, to update run `yarn tsk install`
version: 2.1
jobs:
  test:
    docker:
      - image: circleci/node:10.14.1 # ...with this image as the primary container; this is where all `steps` will run
    steps:
      - build
      - run:
          name: test
          command: yarn tsk test --report
      # Upload test summary for display in Artifacts: https://circleci.com/docs/2.0/artifacts/
      - store_artifacts:
          path: coverage
      - store_artifacts:
          path: reports/junit
      # for display in Test Summary: https://circleci.com/docs/2.0/collect-test-data/
      - store_test_results:
          path: reports/junit
  # See https://circleci.com/docs/2.0/deployment-integrations/#npm for deploy examples
  publish:
    docker:
      - image: circleci/node:10.14.1
    steps:
      - build
      - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
      - run: yarn publish

workflows:
  version: 2
  test-publish: # https://circleci.com/docs/2.0/workflows/#executing-workflows-for-a-git-tag
    jobs:
      - test:
          filters: # required since `publish` has tag filters AND requires `test`
            tags:
              only: /.*/
      - publish:
          requires:
            - test
          filters:
            tags:
              only: /v[0-9]+(\.[0-9]+)*/

commands:
  build:
    steps:
      - checkout
      - run:
          name: update-dependency-manager
          command: "sudo npm install -g yarn@^1.15"
      # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
      - restore_cache:
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: install-dependencies
          command: yarn install
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
